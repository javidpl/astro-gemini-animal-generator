

<div class="chat w-4/5 h-4/5 bg-gray-600 rounded-xl flex flex-col p-4">
  <div id="messages" class="flex-1 overflow-auto space-y-3 p-2 text-white">
  </div>

  <form id="chat-form" class="mt-3 flex gap-2">
    <input
      id="prompt"
      class="flex-1 resize-none p-2 rounded-md bg-slate-800 text-white"
      placeholder="Type a message..."
    />
    <button type="submit" class="bg-yellow-300 px-4 rounded-md">Send</button>
  </form>
  <div class="mt-5 flex justify-center w-[auto] m-auto gap-5">
    <button class="start_btn bg-[#6495ED] w-[fit-content] m-auto pl-5 pr-5 text-white rounded-full">Start Automate</button>
    <select class="" name="set" id="set_select"></select>
  </div>
</div>


<style>
  .chat {
    .msg {
      padding: 0.5rem 0.75rem;
      border-radius: 0.5rem;
      max-width: 75%;
    }
    .msg.user {
      margin-left: auto !important;
      background: rgba(255, 255, 255, 0.08);
    }
    .msg.assistant {
      margin-right: auto;
      background: rgba(255, 255, 255, 0.04);
    }
    input {
      border: 1px solid rgba(255, 255, 255, 0.04);
    }
  }
</style>

<script type="module">
   import chat_controller from "./chat_controller.js";
    chat_controller();

  // Minimal client-only chat script. This runs in the browser; no hydration directives required.
  const form = document.getElementById('chat-form');
  const messagesEl = document.getElementById('messages');
  const promptEl = document.getElementById('prompt');

  

  function appendMessage(role, text) {
    const d = document.createElement('div');
    d.className = 'msg ' + (role === 'user' ? 'user' : 'assistant');
    d.textContent = text;
    messagesEl.appendChild(d);
    messagesEl.scrollTop = messagesEl.scrollHeight;
  }

  function appendImage(role = 'assistant', img_data, img_name) {
    const img = document.createElement('img');
    img.className = 'assistant img w-[250px] h-[250px] mt-50 mr-auto';
    img.src = 'data:image/png;base64,' + img_data;
    img.dataset.name = img_name;
    messagesEl.appendChild(img);
    messagesEl.insertAdjacentHTML(
      'beforeend',
      `<button class="download_btn bg-[#6495ED] pl-5 pr-5 text-white rounded-full" data-name="${img_name}">Download</button>`
    );
    messagesEl.scrollTop = messagesEl.scrollHeight;
    
    document.dispatchEvent(new Event(`img-displayed`));
  }

  form.addEventListener('submit', async (e) => {
     e.preventDefault();
     console.info('submit');
    const prompt = promptEl.value.trim();
    if (!prompt) return;
    appendMessage('user', prompt);
    promptEl.value = '';

    const loader = document.createElement('div');
    loader.className = 'msg assistant';
    loader.textContent = 'â€¦';
    messagesEl.appendChild(loader);
    messagesEl.scrollTop = messagesEl.scrollHeight;

    try {
      const res = await fetch('/api/gemini', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ prompt }),
      });
      console.log({ res });
      loader.remove();

      if (!res.ok) {
        appendMessage('assistant', `Error ${res.status}`);
        return;
      }

      const data = await res.json();
      const reply = data?.reply || data?.output || JSON.stringify(data);

      console.log({ reply });
      const last_user_msg = document.querySelector(
        '.msg.user:last-of-type'
      ).textContent;
      console.log({ last_user_msg });
      reply.forEach((part) => {
        if (part.text) appendMessage('assistant', part.text);
        if (part.inlineData)
          appendImage('assistant', part.inlineData.data, last_user_msg);
      });
    } catch (err) {
      loader.remove();
      appendMessage('assistant', 'Request failed: ' + (err?.message || err));
    }
  });

  document.addEventListener('click', function (e) {
    if (e.target.classList.contains('download_btn')) {
      download_img(e.target.dataset.name);
    }
  });
  function download_img(img_name) {
    console.log('img download');
    const img = document.querySelector(`img[data-name="${img_name}"]`);
    if (!img) return;

    const link = document.createElement('a');
    link.href = img.src;
    link.download = img_name + '.png';
    document.body.appendChild(link);
    link.click();
    setTimeout(() => {
       document.body.removeChild(link);
    }, 1000);
  }
</script>


